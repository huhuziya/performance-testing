数据分析
========
### 压测报告表格
|场景|请求数Sample|Average|Median|90% Line|95% Line|99% Line|Min|Max|Error%|Throughput|Received KB/Sec|Sent KB/Sec|CPU|RPS|
|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|
|10线程运行5分钟|241423|11|11|14|17|22|8|1602|0.00%|804.7/sec|1328.047032|216.1075094|<35%|804/s|

### 性能测试概念
- 并发测试：测试多个用户同时访问同一个应用、同一个模块或者数据记录时是否存在死锁或者其他性能问题，几乎所有的性能测试都会涉及一些并发测试。  
举例：提交问卷场景并发等  
性能预估：实际TPS≈491，cpu≈82  并发预估：并发数=QPS*平均响应时间（理想情况下100ms以内得到响应，即平均响应时间的值应<=100ms）  
所以理想情况下此接口单机能够能承受的最大并发数为491*0.1s=49.1，目前40个并发时，出现数据库死锁

|风险描述|风险环境措施|风险应对措施|
|----|----|----|
|全量核算耗时因在测试环境测试，受网络以及用户影响，耗时统计可能有偏差|经过多轮测试，样本抽取合理结果|无|
|员工单次打卡核算结果接口并发高时出现数据库死锁（测试环境仅一台worker）|打卡用户数猛增|增加服务器，增加worker数|

- 容量测试：通过向应用程序中添加大量的数据来实现。可以通过向数据库插入大量的数据或让应用程序处理一个大型文件来进行测试应用程序，可以识别应用程序中具有大数据时的瓶颈，检查应用程序的效率，进而得到不同数据量级下应用程序的性能。  
举例：导入1000、1万、10万花名册时接口的响应等

- 基准测试：在给系统施加较低压力时，查看系统的运行状况并记录相关数做为基础参考

- 负载测试（Load testing）：是通过逐渐增加系统的负载，测试系统性能的变化，并最终确定在满足系统性能指标的情况下，系统所能承受的最大负载量的测试，即负载测试时通过逐步加压的方式来确定系统的处理能力和能够承受的各项阈值

- 压力测试（Stress Testing）：是通过逐步增加系统的负载，测试系统性能的变化，并最终确定在什么负载条件下，系统性能处于失效状态，并获得系统能提供的最大服务级别的测试。压力测试是逐步增加负载，使系统某些资源达到饱和和甚至失效。

- 瞬压测试（Spike testing）：可以算作是压力测试（Stress Testing）的子集。在目标系统经受短时间内反复增加工作负载，以至超出预期生产操作的负载量时，分析系统的行为，验证其性能特征。它还包括检查应用程序是否可以从突然增加的超预期负荷中恢复出来的测试。  
举例：在电商应用程序中经常有“整点秒杀”的活动，所以在整点时间前后的两三分钟时间里，会有巨大数量的用户进入到该活动中秒杀商品。

- 持久测试（Endurance testing）：也称为稳定性测试，指在相当长的时间内使用预期的负载量对系统进行测试，以检查系统的各种行为，如内存泄露、系统错误、随机行为等，  
举例：CPU资源在70%~90%的使用率的情况下，运行一段时间。

### 技术指标
Average ：每个请求的平均响应时间  
Median ：中值，即50%请求的平均响应时间  
90%Line ：90%请求的响应时间  
95%Line ：95%请求的响应时间  
99%Line ：99%请求的响应时间  
Min ：最小响应时间   
Max ：最大的响应时间  
Error% ：错误响应的概率。即无法响应的概率。  
ThroughPut ：吞吐量， 默认情况下表示每秒完成的请求数（Request per Second），可用{总请求量}/{运行时间} 计算    
```buildoutcfg
吞吐量的指标受到响应时间、服务器软硬件配置、网络状态等多方面因素影响。
- 吞吐量越大，响应时间越长。
- 服务器硬件配置越高，吞吐量越大。
- 网络越差，吞吐量越小。
```

Received KB/Sec ：客户端每秒从服务器端接收到的数据量  
Sent KB/Sec ：客户端每秒发送给服务器端的数据量  

- RPS：即Requests Per Second的缩写，每秒能处理的请求数目。等效于QPS
- QPS：即Queries Per Second的缩写，每秒能处理查询数目
- TPS：即Transactions Per Second的缩写，每秒处理的事务数目
- RT：即Response-time，响应时间，一般取平均响应时间
- 并发数：系统同时处理的request/事务数，类似概念需要区分并发用户数与TPS，秒并发，系统用户数，在线用户数等的区别

计算公式：  
QPS（TPS）= 并发数/平均响应时间
并发数 = QPS*平均响应时间

1. cpu逻辑计算
2. 内存memory读取数据
3. 磁盘I/O存储数据
- 响应时间  
举例：一个页面会发出5次请求，那么这5次请求均落在P90以内概率是90%^5=59%，至少会经历一次 > P90响应时间的概率是 100%-59%=41%，如果你的P90=10s，那么就意味着用户有41%的概率会在加载页面的时候超过10s  
如果你的P99=10s，那么用户只有5%的概率会在访问页面的时候超过10s。如果P99.9=10s，则有0.4%的概率

### 性能工程介绍
#### 性能需求(指标)
按28原则确定指标需求  
TP95用户响应时间在200ms内，支持的最大TPS，且CPU消耗不高于80%
#### 性能测试
1. 准备测试环境和测试数据
2. 测试工具和方法
3. 制定测试模型，编写测试脚本
4. 运行性能测试，监控服务器系统
5. 分析测试报告
#### 性能分析与调优
1. 基本方法：日志追踪分析
2. 工具分析：比如数据库，服务器Pref
3. 调优方向：
网关（硬/软件防火墙）
JVM参数调优
应用系统调优（算法调优、同步到异步、链路访问等）
缓存-CDN、数据缓存
数据库调优（UUID--SnowID、线程数调整）
#### 持续化性能测试
需求迭代
数据量变化，服务器资源配置扩展等

### 工具使用
[Jmeter](https://www.cnblogs.com/yueminghai/p/6412254.html)  
[ab命令](https://www.cnblogs.com/jiftle/p/7158291.html)  
[wrk命令](https://www.cnblogs.com/xinzhao/p/6233009.html)  
[gatling](https://www.jianshu.com/p/90afbd06b69a)  
[Locust](https://blog.csdn.net/jojoy_tester/article/details/77926470)  
[wrk](https://blog.csdn.net/qq_38507328/article/details/86714496)  

