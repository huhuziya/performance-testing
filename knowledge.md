知识补充
=================  
### 性能测试概念
- 并发测试：测试多个用户同时访问同一个应用、同一个模块或者数据记录时是否存在死锁或者其他性能问题，几乎所有的性能测试都会涉及一些并发测试。  
举例：提交问卷场景并发等  
性能预估：实际TPS≈491，cpu≈82  并发预估：并发数=QPS✖平均响应时间（理想情况下100ms-该数据是根据实际业务需求得出的，以内得到响应，即平均响应时间的值应<=100ms）  
所以理想情况下此接口单机能够能承受的最大并发数为491✖0.1s=49.1，目前40个并发时，出现数据库死锁

|风险描述|风险环境措施|风险应对措施|
|----|----|----|
|全量核算耗时因在测试环境测试，受网络以及用户影响，耗时统计可能有偏差|经过多轮测试，样本抽取合理结果|无|
|员工单次打卡核算结果接口并发高时出现数据库死锁（测试环境仅一台worker）|打卡用户数猛增|增加服务器，增加worker数|

- 容量测试：通过向应用程序中添加大量的数据来实现。可以通过向数据库插入大量的数据或让应用程序处理一个大型文件来进行测试应用程序，可以识别应用程序中具有大数据时的瓶颈，检查应用程序的效率，进而得到不同数据量级下应用程序的性能。  
举例：导入1000、1万、10万花名册时接口的响应等

- 基准测试：在给系统施加较低压力时，查看系统的运行状况并记录相关数做为基础参考

- 负载测试（Load testing）：是通过逐渐增加系统的负载，测试系统性能的变化，并最终确定在满足系统性能指标的情况下，系统所能承受的最大负载量的测试，即负载测试时通过逐步加压的方式来确定系统的处理能力和能够承受的各项阈值

- 压力测试（Stress Testing）：是通过逐步增加系统的负载，测试系统性能的变化，并最终确定在什么负载条件下，系统性能处于失效状态，并获得系统能提供的最大服务级别的测试。压力测试是逐步增加负载，使系统某些资源达到饱和和甚至失效。

- 瞬压测试（Spike testing）：可以算作是压力测试（Stress Testing）的子集。在目标系统经受短时间内反复增加工作负载，以至超出预期生产操作的负载量时，分析系统的行为，验证其性能特征。它还包括检查应用程序是否可以从突然增加的超预期负荷中恢复出来的测试。  
举例：在电商应用程序中经常有“整点秒杀”的活动，所以在整点时间前后的两三分钟时间里，会有巨大数量的用户进入到该活动中秒杀商品。

- 持久测试（Endurance testing）：也称为稳定性测试，指在相当长的时间内使用预期的负载量对系统进行测试，以检查系统的各种行为，如内存泄露、系统错误、随机行为等，  
举例：CPU资源在70%~90%的使用率的情况下，运行一段时间。

### Jmeter分布式压测原理
[参考链接](https://blog.csdn.net/weixin_44275820/article/details/108233954)
- 控制机的节点叫master，其他产生压力的机器叫slaves ，即负载机  
- master会把压测脚本发送到 slaves上面  
- 执行的时候，slaves上只需要把jmeter-server打开就可以了，不用启动jmeter  
- 结束后，slaves会把压测数据回传给master,然后master汇总输出报告和配置详情  

> 注意：必须保证master和slaves安装相同的jdk和jmeter  
> 前提：master的jmeter可以正常打开使用，master和slaves处于同一个局域网下，相互之间可以ping通

### API网关
[参考链接](https://vincentruan.github.io/2020/02/27/%E5%BE%AE%E6%9C%8D%E5%8A%A1-API%E7%BD%91%E5%85%B3/)

1. 协议转换：每个系统使用的协议不同，系统之间的调用或者数据传输，存在协议的转化问题  
处理方法：API网关通过泛化调用的方式实现协议之间的转化
2. 异步请求：如果把网络请求看成一次 IO 操作的话，处理请求的线程，从接受请求，到服务返回响应，都是阻塞状态。  
处理方法：一旦，发现请求事件，就会调用对应的应用。获取应用返回的信息以后，按照请求的要求把数据/文件放到指定的缓冲区，同时发送一个通知事件，告诉请求端数据已经就绪，可以从这个缓冲获取数据/文件。
3. 负载均衡：高可用网络基础架构的关键组件，通常用于将工作负载分布到多个服务器来提高网站、应用、数据库或其他服务的性能和可靠性。
4. 统一鉴权：访问应用服务器的请求都需要拥有一定权限，如果说每访问一个服务都需要验证一次权限，这个对效率是很大的影响。可以把权限认证放到 API 网关来进行。  
例子：用户通过登录服务获取 Token，把它存放到客户端，在每次请求的时候把这个 Token 放入请求头，一起发送给服务器。API 网关要做的事情就是解析这个 Token，知道访问者是谁（鉴定），他能做什么/访问什么（权限）。
5. 缓存数据：
- 用户请求先访问 API 网关，如果发现有缓存信息，直接返回给用户。
- 如果没有发现缓存信息，回源到应用服务器获取信息。
- 另外，有一个缓存更新服务，定期把应用服务器中的信息更新到网关本地缓存中。
![示例](https://vincentruan.github.io/2020/02/27/%E5%BE%AE%E6%9C%8D%E5%8A%A1-API%E7%BD%91%E5%85%B3/640-1582786344099.webp)

### 压测经验总结
#### 1、为什么jmeter要做分布式，为什么会遇到内存溢出的错误？
因为jmeter是java写的应用，java应用jvm堆内存heap受负载机硬件限制，虽然我们可以调整堆内存大小，但是单机无法支撑数以万计大并发，此时，需要多个负载机进行分压测试，这样性能瓶颈就不会受负载机硬件限制  

#### 2、服务器监控的jar包没启动起来
压测接口会报ERROR:java.net.ConnectException:Connection refused:connect  
处理方法：需要开发启用该服务

#### 3、数据库存在缓存，拿的都是缓存的数据
问题：同一份问卷反复压，测试使用的问卷相关参数都是一样，数据库里都是热数据，导致压测结果不准确
处理方法1：每次压测都更换问卷id，确保数据都是最新的，不是拿的缓存
处理方法2：测试完我重启数据库

#### 4、TPS偏低
处理方法：开发对接口的SQL调整，优化sql查询索引

#### 5、压测脚本和运行界面不要同时打开，会报错

#### 6、ping通压测机方法
ping 压测接口域名 [内网IP]
ping master机的IP [slaves机的IP]
> 前提:一定要保证master和slaves安装相同的jdk和jmeter，master和slaves处于同一个局域网下，相互之间可以ping通

#### 7、调试压测环境，打开错误日志，勾选仅错误日志选项
注意：压测时需取消勾选【仅错误日志】选项，以免打印日志信息影响压测结果  
打开日志与jmeter界面右上方叹号

#### 8、为了去掉token鉴权影响，使用内部接口来压测

#### 9、要提前结束压测ctrl+c,要重新启动分布式压测，请重新启动slaves

#### 10、Http和Https的默认端口是什么
Apache server (Http)的默认端口是80  
SSL (Https)的默认端口是443

#### 11、HTTP错误码
400无法解析此请求  
403禁止访问：访问被拒绝  
404找不到文件或目录  
405用于访问该页的HTTP动作未被许可  
410文件已删除  
500服务器内部错误  
501标题值指定的配置没有执行  
502 Web服务器作为网关或代理服务器时收到无效的响应  

### 性能工程介绍
#### 1、性能需求(指标)
按28原则确定指标需求  
TP95用户响应时间在200ms内，支持的最大TPS，且CPU消耗不高于80%
#### 2、性能测试
1. 准备测试环境和测试数据
2. 测试工具和方法
3. 制定测试模型，编写测试脚本
4. 运行性能测试，监控服务器系统
5. 分析测试报告
#### 3、性能分析与调优
1. 基本方法：日志追踪分析
2. 工具分析：比如数据库，服务器Pref
3. 调优方向：
网关（硬/软件防火墙）
JVM参数调优
应用系统调优（算法调优、同步到异步、链路访问等）
缓存-CDN、数据缓存
数据库调优（UUID--SnowID、线程数调整）
#### 4、持续化性能测试
需求迭代
数据量变化，服务器资源配置扩展等

### 工具使用
[Jmeter](https://www.cnblogs.com/yueminghai/p/6412254.html)  
[ab命令](https://www.cnblogs.com/jiftle/p/7158291.html)  
[wrk命令](https://www.cnblogs.com/xinzhao/p/6233009.html)  
[gatling](https://www.jianshu.com/p/90afbd06b69a)  
[Locust](https://blog.csdn.net/jojoy_tester/article/details/77926470)  
[wrk](https://blog.csdn.net/qq_38507328/article/details/86714496)  

