### 压力测试操作流程

#### 压测申请表
压测目标：部署项目名称、压测接口  
***压测接口和场景说明***

|  接口依赖   | 是否有经过网关鉴权 | 是否内部接口调用 | 接口有无异步任务逻辑 |是否有缓存 |缓存时间 |
|  ----  | ----  |----  |----  |----  |----  |
| 有 | 有 | 有 | 有 | 有 | 有 |
| --  | 调用内部接口获取token |响应时间变长 |-- |拿数据库/代码缓存数据返回 |--|

***硬件环境要求（CPU、内存、磁盘类型等）***
4C8G Linux 内网访问
- 注意：环境对压力测试的影响，规避掉网络层不同因素的影响，可以考虑直接在服务器本机上跑压测程序
- ab压力测试弊端：ab是单线程程序，只能利用单一CPU，在给性能好的服务器端应用做压测时，往往跑ab的测试机负荷满了；而服务器应用的性能还绰绰有余。
比方说，应用程序反复查询、返回同一个账号的资料，跟随机查询、返回十万个用户是不一样的；前者的返回结果很容易就被数据库、应用给“缓存”掉。而对于被严重“缓存”的性能测试结果，并不能很好的反应真实场景下的性能表现。
[参考连接](https://www.zhihu.com/question/19867883)  

***在以上硬件环境下的其他指标***  
1. 并发线程数要求：等同在另外一台 4C8G Linux 内网机器上基于内网 IP 使用 wrk 执行 4 threads 100 connections
2. QPS指标：
```
hello world > 25k
redis ping > 10k
mysql ping > 5k
走 redis 缓存 > 5k
走 mysql 查询 > 1.5k
```
3. TPS指标:无
4. CPU消耗指标:99%，如果CPU达不到95%以上说明压测方发出的请求压力还不够
5. 平均响应时间指标:
6. Throughput吞吐量：取最大的那个数值
```buildoutcfg
hello world 平均约25ms 最快15ms 最大150ms
走 redis 缓存平均约60ms 最小25ms 最大250ms
走 mysql 查询平均约200ms 最小100ms 最大500ms
```
#### 数据分析
- 响应时间  
举例：一个页面会发出5次请求，那么这5次请求均落在P90以内概率是90%^5=59%，至少会经历一次 > P90响应时间的概率是 100%-59%=41%，如果你的P90=10s，那么就意味着用户有41%的概率会在加载页面的时候超过10s  
如果你的P99=10s，那么用户只有5%的概率会在访问页面的时候超过10s。如果P99.9=10s，则有0.4%的概率

#### 知识补充  
[API网关](https://vincentruan.github.io/2020/02/27/%E5%BE%AE%E6%9C%8D%E5%8A%A1-API%E7%BD%91%E5%85%B3/)

1. 协议转换：每个系统使用的协议不同，系统之间的调用或者数据传输，存在协议的转化问题  
处理方法：API网关通过泛化调用的方式实现协议之间的转化
2. 异步请求：如果把网络请求看成一次 IO 操作的话，处理请求的线程，从接受请求，到服务返回响应，都是阻塞状态。  
处理方法：一旦，发现请求事件，就会调用对应的应用。获取应用返回的信息以后，按照请求的要求把数据/文件放到指定的缓冲区，同时发送一个通知事件，告诉请求端数据已经就绪，可以从这个缓冲获取数据/文件。
3. 负载均衡：高可用网络基础架构的关键组件，通常用于将工作负载分布到多个服务器来提高网站、应用、数据库或其他服务的性能和可靠性。
4. 统一鉴权：访问应用服务器的请求都需要拥有一定权限，如果说每访问一个服务都需要验证一次权限，这个对效率是很大的影响。可以把权限认证放到 API 网关来进行。  
例子：用户通过登录服务获取 Token，把它存放到客户端，在每次请求的时候把这个 Token 放入请求头，一起发送给服务器。API 网关要做的事情就是解析这个 Token，知道访问者是谁（鉴定），他能做什么/访问什么（权限）。
5. 缓存数据：
- 用户请求先访问 API 网关，如果发现有缓存信息，直接返回给用户。
- 如果没有发现缓存信息，回源到应用服务器获取信息。
- 另外，有一个缓存更新服务，定期把应用服务器中的信息更新到网关本地缓存中。
![示例](https://vincentruan.github.io/2020/02/27/%E5%BE%AE%E6%9C%8D%E5%8A%A1-API%E7%BD%91%E5%85%B3/640-1582786344099.webp)
